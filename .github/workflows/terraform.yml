name: Terraform on Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Sync Render secrets to HCP Terraform workspace
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_OWNER_ID: ${{ secrets.RENDER_OWNER_ID }}
        run: |
          set -euo pipefail
          ORG="terraform-training-mehdi"
          WORKSPACE="terraform-training"
          
          ws_json=$(curl -sS \
            --header "Authorization: Bearer $TF_API_TOKEN" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/$ORG/workspaces/$WORKSPACE)
          ws_id=$(echo "$ws_json" | jq -r '.data.id')
          
          upsert_var() {
            local key="$1" value="$2" sensitive="$3"
            vars_json=$(curl -sS \
              --header "Authorization: Bearer $TF_API_TOKEN" \
              --header "Content-Type: application/vnd.api+json" \
              https://app.terraform.io/api/v2/workspaces/$ws_id/vars)
            var_id=$(echo "$vars_json" | jq -r --arg k "$key" '.data[] | select(.attributes.key==$k) | .id' | head -n1)
            
            payload=$(jq -n \
              --arg k "$key" \
              --arg v "$value" \
              --arg s "$sensitive" \
              --arg wid "$ws_id" \
              '{
                data: {
                  type: "vars",
                  attributes: {
                    key: $k,
                    value: $v,
                    category: "env",
                    hcl: false,
                    sensitive: ($s == "true")
                  },
                  relationships: {
                    workspace: { data: { id: $wid, type: "workspaces" } }
                  }
                }
              }')
            
            if [ -n "$var_id" ]; then
              curl -sS -X PATCH \
                --header "Authorization: Bearer $TF_API_TOKEN" \
                --header "Content-Type: application/vnd.api+json" \
                --data "$payload" \
                https://app.terraform.io/api/v2/workspace-variables/$var_id >/dev/null
            else
              curl -sS -X POST \
                --header "Authorization: Bearer $TF_API_TOKEN" \
                --header "Content-Type: application/vnd.api+json" \
                --data "$payload" \
                https://app.terraform.io/api/v2/vars >/dev/null
            fi
          }
          
          upsert_var "RENDER_API_KEY" "$RENDER_API_KEY" "true"
          upsert_var "RENDER_OWNER_ID" "$RENDER_OWNER_ID" "true"

      - name: Terraform Init
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_OWNER_ID: ${{ secrets.RENDER_OWNER_ID }}
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: terraform init

      - name: Terraform Format Check
        run: terraform fmt -check

      - name: Terraform Destroy
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_OWNER_ID: ${{ secrets.RENDER_OWNER_ID }}
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: terraform destroy -auto-approve

      - name: Terraform Plan
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_OWNER_ID: ${{ secrets.RENDER_OWNER_ID }}
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: terraform plan -no-color

      - name: Terraform Apply 
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_OWNER_ID: ${{ secrets.RENDER_OWNER_ID }}
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: terraform apply -auto-approve