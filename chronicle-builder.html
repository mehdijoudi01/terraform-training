<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicle Builder - Choice Chronicles</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .back-btn, .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            color: white;
        }

        .back-btn:hover, .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        body.dark-mode .container {
            background: #0f3460;
        }

        .game-content {
            padding: 40px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .title {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        body.dark-mode .title {
            color: #e0e0e0;
        }

        .api-status {
            background: #e8f4f8;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #0066cc;
            margin-bottom: 15px;
            text-align: center;
        }

        body.dark-mode .api-status {
            background: #1a2a3a;
            color: #7db8ff;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        body.dark-mode .stat-box {
            background: #1a1a2e;
        }

        .stat-value {
            color: #667eea;
            font-size: 1.5em;
            font-weight: bold;
        }

        body.dark-mode .stat-value {
            color: #9fb3ff;
        }

        .stat-label {
            color: #999;
            font-size: 0.9em;
            margin-top: 5px;
        }

        body.dark-mode .stat-label {
            color: #7db8ff;
        }

        .event-display {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
            min-height: 150px;
        }

        body.dark-mode .event-display {
            background: #16213e;
            border-color: #9fb3ff;
        }

        .event-title {
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        body.dark-mode .event-title {
            color: #9fb3ff;
        }

        .event-description {
            color: #555;
            line-height: 1.8;
            font-size: 1.05em;
        }

        body.dark-mode .event-description {
            color: #b0b0b0;
        }

        .consequences {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            color: #664d03;
            border-left: 4px solid #ffc107;
        }

        body.dark-mode .consequences {
            background: #4a3900;
            color: #ffc107;
        }

        .choices-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .choice-btn {
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-btn:hover {
            background: #764ba2;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .history-timeline {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        body.dark-mode .history-timeline {
            background: #1a1a2e;
        }

        .timeline-event {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
            color: #555;
            font-size: 0.95em;
        }

        body.dark-mode .timeline-event {
            background: #16213e;
            color: #b0b0b0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: auto;
        }

        .btn {
            flex: 1;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .intro-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .intro-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        body.dark-mode .intro-content {
            background: #0f3460;
            color: #e0e0e0;
        }

        .intro-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        body.dark-mode .intro-content h2 {
            color: #9fb3ff;
        }

        .intro-content p {
            color: #555;
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 1.05em;
        }

        body.dark-mode .intro-content p {
            color: #b0b0b0;
        }

        .intro-content .highlight {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        body.dark-mode .intro-content .highlight {
            background: #1a2a3a;
            border-color: #9fb3ff;
        }

        .intro-content ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .intro-content li {
            color: #555;
            margin-bottom: 10px;
        }

        body.dark-mode .intro-content li {
            color: #b0b0b0;
        }

        .start-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
        }

        .start-btn:hover {
            background: #764ba2;
        }

        body.dark-mode #choicePrompt {
            color: #e0e0e0;
        }

        .leader-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .diplomatic-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .diplomatic-modal.show {
            display: flex !important;
        }

        .diplomatic-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .diplomatic-content {
            background: #0f3460;
            color: #e0e0e0;
        }

        body.dark-mode .diplomatic-content h2 {
            color: #9fb3ff;
        }
        
        body.dark-mode .diplomatic-content .choice-btn {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .game-content {
                padding: 20px;
            }

            .title {
                font-size: 1.8em;
            }

            .choices-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }

            .intro-content {
                padding: 25px;
            }

            .intro-content h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <script>
        // Define critical functions early to avoid ReferenceError
        let selectedLeader = null;
        
        function selectLeader(leaderType) {
            selectedLeader = leaderType;
            // Highlight selected leader
            document.querySelectorAll('.leader-card').forEach(card => {
                card.style.borderColor = 'transparent';
                card.style.boxShadow = '';
            });
            const cards = document.querySelectorAll('.leader-card');
            cards.forEach(card => {
                if (card.onclick && card.onclick.toString().includes(leaderType)) {
                    card.style.borderColor = '#ffd700';
                    card.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.5)';
                }
            });
            
            // Show difficulty selection
            document.getElementById('leaderSelection').style.display = 'none';
            document.getElementById('difficultySelection').style.display = 'block';
        }
    </script>
    
    <div class="intro-modal" id="introModal">
        <div class="intro-content">
            <h2>üìñ Welcome to Chronicle Builder</h2>
            <p><strong>Lead a Civilization Through History</strong></p>
            <p>Guide your civilization through 10 critical historical moments. Every choice matters‚Äîshape the future or watch it crumble!</p>
            
            <div class="highlight">
                <strong>üéØ Your Mission:</strong>
                <ul>
                    <li>Survive 10 turns making critical decisions</li>
                    <li>Manage 4 key attributes (Stability, Innovation, Culture, Economy)</li>
                    <li>Adapt to evolving events based on your choices</li>
                    <li>Achieve victory through balance or dominance</li>
                </ul>
            </div>

            <p><strong>‚öñÔ∏è The Four Pillars:</strong></p>
            <ul>
                <li><strong>Stability (0-100):</strong> Order, security, and cohesion. Too low = collapse!</li>
                <li><strong>Innovation (0-100):</strong> Progress and technological advancement</li>
                <li><strong>Culture (0-100):</strong> Arts, philosophy, and social values</li>
                <li><strong>Economy (0-100):</strong> Prosperity and resource management</li>
            </ul>

            <p><strong>üíé New Mechanics:</strong></p>
            <ul>
                <li><strong>Random Events:</strong> Natural disasters, lucky breaks, and black swans can strike anytime!</li>
                <li><strong>Prestige Points:</strong> Earn and spend strategic resources to influence outcomes</li>
                <li><strong>Stat Decay:</strong> Weak stats worsen over time - stay vigilant!</li>
                <li><strong>Event Memory:</strong> Past choices return with consequences 2-3 turns later</li>
                <li><strong>Difficulty Modes:</strong> Normal, Hard (start at 40), Nightmare (start at 30)</li>
            </ul>

            <div class="highlight">
                <strong>‚ö†Ô∏è Warning:</strong> If ANY attribute drops to 0, your civilization collapses immediately! Low stats (<20) cause automatic decay. Balance is survival!</div>

            <p style="text-align: center; margin-top: 25px; font-size: 1.1em;"><strong>Will you forge a golden age or descend into chaos?</strong></p>
            
            <p style="text-align: center; margin-top: 25px; font-size: 1.1em;"><strong>Choose your leader:</strong></p>
            <div id="leaderSelection" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                <div class="leader-card" onclick="selectLeader('conqueror')" style="padding: 15px; background: linear-gradient(135deg, #ff6b6b, #c92a2a); border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 3px solid transparent;">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 8px;">‚öîÔ∏è</div>
                    <div style="font-weight: bold; text-align: center; color: white; margin-bottom: 5px;">The Conqueror</div>
                    <div style="font-size: 0.85em; text-align: center; color: rgba(255,255,255,0.9);">+2 Stability/turn, -1 Culture/turn</div>
                </div>
                <div class="leader-card" onclick="selectLeader('scholar')" style="padding: 15px; background: linear-gradient(135deg, #4dabf7, #1c7ed6); border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 3px solid transparent;">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 8px;">üìö</div>
                    <div style="font-weight: bold; text-align: center; color: white; margin-bottom: 5px;">The Scholar</div>
                    <div style="font-size: 0.85em; text-align: center; color: rgba(255,255,255,0.9);">+3 Innovation/turn, -1 Economy/turn</div>
                </div>
                <div class="leader-card" onclick="selectLeader('diplomat')" style="padding: 15px; background: linear-gradient(135deg, #51cf66, #2f9e44); border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 3px solid transparent;">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 8px;">ü§ù</div>
                    <div style="font-weight: bold; text-align: center; color: white; margin-bottom: 5px;">The Diplomat</div>
                    <div style="font-size: 0.85em; text-align: center; color: rgba(255,255,255,0.9);">+2 Culture, +1 Stability/turn</div>
                </div>
                <div class="leader-card" onclick="selectLeader('merchant')" style="padding: 15px; background: linear-gradient(135deg, #ffd43b, #fab005); border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 3px solid transparent;">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 8px;">üí∞</div>
                    <div style="font-weight: bold; text-align: center; color: white; margin-bottom: 5px;">The Merchant</div>
                    <div style="font-size: 0.85em; text-align: center; color: rgba(255,255,255,0.9);">+3 Economy, +1 Prestige/turn</div>
                </div>
                <div class="leader-card" onclick="selectLeader('revolutionary')" style="padding: 15px; background: linear-gradient(135deg, #ff6b9d, #c92a7c); border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 3px solid transparent; grid-column: span 2;">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 8px;">üî•</div>
                    <div style="font-weight: bold; text-align: center; color: white; margin-bottom: 5px;">The Revolutionary</div>
                    <div style="font-size: 0.85em; text-align: center; color: rgba(255,255,255,0.9);">+2 Momentum/turn, -1 Stability/turn</div>
                </div>
            </div>
            
            <div id="difficultySelection" style="display: none;">
                <p style="text-align: center; margin-top: 25px; font-size: 1.1em;"><strong>Choose your difficulty:</strong></p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                <button class="start-btn" onclick="setTimeout(() => startGame('normal'), 0)" style="background: #4CAF50; padding: 15px;">üéÆ Normal<br><span style="font-size: 0.8em;">Start at 50</span></button>
                <button class="start-btn" onclick="setTimeout(() => startGame('hard'), 0)" style="background: #FF9800; padding: 15px;">‚öîÔ∏è Hard<br><span style="font-size: 0.8em;">Start at 40</span></button>
                <button class="start-btn" onclick="setTimeout(() => startGame('nightmare'), 0)" style="background: #f44336; padding: 15px;">üíÄ Nightmare<br><span style="font-size: 0.8em;">Start at 30</span></button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .leader-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .leader-card.selected {
            border: 3px solid #fff !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        .rival-box {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        body.dark-mode .rival-box {
            background: #1a1a2e;
            border-color: #9fb3ff;
        }
        .rival-power-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .rival-power-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }
        .diplomatic-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .diplomatic-modal.show {
            display: flex;
        }
        .diplomatic-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
        }
        body.dark-mode .diplomatic-content {
            background: #0f3460;
            color: #e0e0e0;
        }
    </style>

    <div class="header-bar">
        <button class="back-btn" onclick="goBack()" title="Back to Hub">‚Üê</button>
        <h1 style="color: white; flex: 1; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üìñ Chronicle Builder</h1>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåô</button>
    </div>

    <div class="container">
        <div class="game-content">
            <div class="api-status" id="apiStatus">üîÑ Loading historical data...</div>

            <div id="leaderDisplay" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white; display: none;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="leaderEmoji" style="font-size: 3em;">‚öîÔ∏è</div>
                    <div style="flex: 1;">
                        <div id="leaderName" style="font-size: 1.3em; font-weight: bold;">The Conqueror</div>
                        <div id="leaderBonus" style="font-size: 0.9em; opacity: 0.9;">+2 Stability/turn</div>
                    </div>
                    <button id="leaderActionBtn" onclick="useLeaderAction()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 8px; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        ‚ö° Special Action
                    </button>
                </div>
            </div>

            <div id="rivalsDisplay" style="display: none; margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 10px; font-size: 1.1em;">üåç Civilization Rankings</h3>
                
                <!-- Player Score -->
                <div id="playerScore" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 12px; border-radius: 8px; margin-bottom: 10px; color: white; border: 3px solid #ffd700;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="playerRankEmoji" style="font-size: 1.5em;">ü•á</span>
                            <div>
                                <div style="font-weight: bold; font-size: 1.1em;">üëë Your Civilization</div>
                                <div id="playerLeaderName" style="font-size: 0.85em; opacity: 0.9;">The Conqueror</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div id="playerTotalScore" style="font-size: 1.5em; font-weight: bold;">200</div>
                            <div style="font-size: 0.8em; opacity: 0.9;">Total Power</div>
                        </div>
                    </div>
                    <div style="margin-top: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="playerPowerBar" style="width: 50%; background: #ffd700; height: 100%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div id="rivalsList"></div>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="stabilityDisplay">50</div>
                    <div class="stat-label">‚öñÔ∏è Stability</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="innovationDisplay">50</div>
                    <div class="stat-label">‚ö° Innovation</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="cultureDisplay">50</div>
                    <div class="stat-label">üé≠ Culture</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="economyDisplay">50</div>
                    <div class="stat-label">üí∞ Economy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="prestigeDisplay">0</div>
                    <div class="stat-label">üíé Prestige</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="momentumDisplay">0</div>
                    <div class="stat-label">üìà Momentum</div>
                </div>
            </div>
            
            <div style="background: #e0e0e0; border-radius: 10px; height: 30px; margin-bottom: 20px; overflow: hidden;">
                <div id="progressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                    Turn 0/10
                </div>
            </div>

            <div class="event-display">
                <div class="event-title" id="eventTitle">üìú Your Chronicle Begins...</div>
                <div class="event-description" id="eventDescription">Press "Begin Your Chronicle" to start your journey through history.</div>
                <div class="consequences" id="consequences" style="display: none;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;" id="choicePrompt">ü§î What will you do?</h3>
                <div class="choices-grid" id="choicesContainer"></div>
            </div>

            <div class="history-timeline" id="historyTimeline">
                <div style="text-align: center; color: #999;">Your chronicle will unfold here...</div>
            </div>

            <div class="action-buttons">
                <button class="btn secondary" onclick="resetGame()">üîÑ Reset Chronicle</button>
                <button class="btn" onclick="shareStory()">üì§ Share Story</button>
            </div>
        </div>
    </div>

    <div class="diplomatic-modal" id="diplomaticModal">
        <div class="diplomatic-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ü§ù Diplomatic Phase</h2>
            <p id="diplomaticText" style="margin-bottom: 20px; line-height: 1.6;">Choose your diplomatic stance with rival civilizations.</p>
            <div id="diplomaticChoices" style="display: grid; gap: 10px;"></div>
        </div>
    </div>

    <script>
        let gameState = {
            turn: 0,
            maxTurns: 10,
            stability: 50,
            innovation: 50,
            culture: 50,
            economy: 50,
            decisions: [],
            currentEra: null,
            gameOver: false,
            // New enhanced features
            prestige: 0,
            reputation: { militaristic: 0, peaceful: 0, progressive: 0, traditional: 0 },
            activeThreats: [],
            achievements: [],
            momentum: 0,
            eventMemory: [],
            technologies: [],
            leader: null,
            leaderActionUsed: false,
            difficulty: 'normal', // normal, hard, nightmare
            rivals: [],
            diplomaticPhase: false,
            diplomaticActionTaken: false,
            warWith: []
        };

        // Leader archetypes
        const leaders = {
            conqueror: {
                name: 'The Conqueror',
                emoji: '‚öîÔ∏è',
                description: 'Military prowess and territorial expansion',
                bonuses: { stability: 2 },
                penalties: { culture: -1 },
                special: 'Declare War (no stability penalty, +15 to all stats if won)',
                startBonus: { stability: 10 }
            },
            scholar: {
                name: 'The Scholar',
                emoji: 'üìö',
                description: 'Knowledge, research, and innovation',
                bonuses: { innovation: 3 },
                penalties: { economy: -1 },
                special: 'Eureka Moment (instantly unlock a random technology)',
                startBonus: { innovation: 15 }
            },
            diplomat: {
                name: 'The Diplomat',
                emoji: 'ü§ù',
                description: 'Peace, alliances, and cooperation',
                bonuses: { culture: 2, stability: 1 },
                penalties: {},
                special: 'Peace Summit (reset all rivalries, +10 to all stats)',
                startBonus: { culture: 10 }
            },
            merchant: {
                name: 'The Merchant',
                emoji: 'üí∞',
                description: 'Trade, wealth, and prosperity',
                bonuses: { economy: 3, prestige: 1 },
                penalties: { innovation: -1 },
                special: 'Golden Age (double economy gains for 3 turns)',
                startBonus: { economy: 15 }
            },
            revolutionary: {
                name: 'The Revolutionary',
                emoji: 'üî•',
                description: 'Radical change and bold reforms',
                bonuses: { momentum: 2 },
                penalties: { stability: -1 },
                special: 'Revolution (reroll all stats to 50 + gain 20 prestige)',
                startBonus: { momentum: 5 }
            }
        };

        const eras = [
            { name: 'Ancient Mesopotamia', year: -3000, period: '3500-539 BCE', wikiTopic: 'Mesopotamia' },
            { name: 'Ancient Egypt', year: -1500, period: '3000-30 BCE', wikiTopic: 'Ancient_Egypt' },
            { name: 'Indus Valley Civilization', year: -2500, period: '3300-1300 BCE', wikiTopic: 'Indus_Valley_Civilisation' },
            { name: 'Ancient China (Shang Dynasty)', year: -1200, period: '1600-1046 BCE', wikiTopic: 'Shang_dynasty' },
            { name: 'Classical Greece', year: -400, period: '800-146 BCE', wikiTopic: 'Ancient_Greece' },
            { name: 'Persian Empire', year: -500, period: '550-330 BCE', wikiTopic: 'Achaemenid_Empire' },
            { name: 'Maurya Empire (India)', year: -250, period: '322-185 BCE', wikiTopic: 'Maurya_Empire' },
            { name: 'Roman Republic', year: -100, period: '509-27 BCE', wikiTopic: 'Roman_Republic' },
            { name: 'Roman Empire', year: 100, period: '27 BCE-476 CE', wikiTopic: 'Roman_Empire' },
            { name: 'Han Dynasty (China)', year: 50, period: '206 BCE-220 CE', wikiTopic: 'Han_dynasty' },
            { name: 'Byzantine Empire', year: 600, period: '330-1453 CE', wikiTopic: 'Byzantine_Empire' },
            { name: 'Islamic Golden Age', year: 800, period: '8th-14th century', wikiTopic: 'Islamic_Golden_Age' },
            { name: 'Viking Age', year: 900, period: '793-1066 CE', wikiTopic: 'Viking_Age' },
            { name: 'Medieval Europe', year: 1000, period: '500-1500 CE', wikiTopic: 'Middle_Ages' },
            { name: 'Mongol Empire', year: 1250, period: '1206-1368 CE', wikiTopic: 'Mongol_Empire' },
            { name: 'Ming Dynasty (China)', year: 1400, period: '1368-1644 CE', wikiTopic: 'Ming_dynasty' },
            { name: 'Renaissance', year: 1500, period: '14th-17th century', wikiTopic: 'Renaissance' },
            { name: 'Age of Exploration', year: 1550, period: '15th-17th century', wikiTopic: 'Age_of_Discovery' },
            { name: 'Ottoman Empire', year: 1600, period: '1299-1922 CE', wikiTopic: 'Ottoman_Empire' },
            { name: 'Age of Enlightenment', year: 1700, period: '17th-18th century', wikiTopic: 'Age_of_Enlightenment' },
            { name: 'American Revolution', year: 1776, period: '1765-1783', wikiTopic: 'American_Revolution' },
            { name: 'French Revolution', year: 1789, period: '1789-1799', wikiTopic: 'French_Revolution' },
            { name: 'Industrial Revolution', year: 1800, period: '1760-1840', wikiTopic: 'Industrial_Revolution' },
            { name: 'Napoleonic Wars', year: 1810, period: '1803-1815', wikiTopic: 'Napoleonic_Wars' },
            { name: 'Victorian Era', year: 1850, period: '1837-1901', wikiTopic: 'Victorian_era' },
            { name: 'American Civil War', year: 1863, period: '1861-1865', wikiTopic: 'American_Civil_War' },
            { name: 'Gilded Age', year: 1880, period: '1870-1900', wikiTopic: 'Gilded_Age' },
            { name: 'Progressive Era', year: 1910, period: '1890-1920', wikiTopic: 'Progressive_Era' },
            { name: 'World War I', year: 1918, period: '1914-1918', wikiTopic: 'World_War_I' },
            { name: 'Roaring Twenties', year: 1925, period: '1920-1929', wikiTopic: 'Roaring_Twenties' },
            { name: 'Great Depression', year: 1933, period: '1929-1939', wikiTopic: 'Great_Depression' },
            { name: 'World War II', year: 1943, period: '1939-1945', wikiTopic: 'World_War_II' },
            { name: 'Post-War Boom', year: 1955, period: '1945-1960', wikiTopic: 'Post‚ÄìWorld_War_II_economic_expansion' },
            { name: 'Cold War', year: 1965, period: '1947-1991', wikiTopic: 'Cold_War' },
            { name: 'Space Race', year: 1969, period: '1955-1975', wikiTopic: 'Space_Race' },
            { name: 'Civil Rights Era', year: 1968, period: '1954-1968', wikiTopic: 'Civil_rights_movement' },
            { name: 'Oil Crisis', year: 1973, period: '1973-1974', wikiTopic: '1973_oil_crisis' },
            { name: 'Digital Revolution', year: 1985, period: '1980-2000', wikiTopic: 'Digital_Revolution' },
            { name: 'End of Cold War', year: 1991, period: '1989-1991', wikiTopic: 'Dissolution_of_the_Soviet_Union' },
            { name: 'Dot-com Era', year: 1999, period: '1995-2001', wikiTopic: 'Dot-com_bubble' },
            { name: 'Post-9/11 Era', year: 2005, period: '2001-2010', wikiTopic: 'War_on_terror' },
            { name: 'Great Recession', year: 2009, period: '2007-2009', wikiTopic: 'Great_Recession' },
            { name: 'Social Media Age', year: 2015, period: '2010-2020', wikiTopic: 'Social_media' },
            { name: 'AI Revolution', year: 2023, period: '2020-Present', wikiTopic: 'Artificial_intelligence' },
            { name: 'Modern Era', year: 2025, period: '2020-Present', wikiTopic: '2020s' }
        ];

        // New: Random event system
        function checkRandomEvents() {
            const roll = Math.random() * 100;
            
            // 15% Natural Disaster
            if (roll < 15) {
                return {
                    type: 'disaster',
                    title: 'üåä NATURAL DISASTER!',
                    description: ['Earthquake devastates cities', 'Plague sweeps the land', 'Drought destroys harvests', 'Floods wash away infrastructure'][Math.floor(Math.random() * 4)],
                    choices: [
                        { text: 'üèóÔ∏è Emergency reconstruction', effects: { stability: -15, innovation: 5, culture: -5, economy: -20 } },
                        { text: 'üôè Turn to faith and prayer', effects: { stability: -10, innovation: -15, culture: 10, economy: -15 } },
                        { text: 'üí∞ Pay for foreign aid', effects: { stability: -5, innovation: 0, culture: -10, economy: -25 } }
                    ]
                };
            }
            
            // 5% Black Swan Event
            if (roll < 20) {
                return {
                    type: 'blackswan',
                    title: 'üíÄ BLACK SWAN EVENT!',
                    description: ['Neighboring empire invades!', 'Revolutionary uprising explodes!', 'Economic bubble bursts catastrophically!', 'Assassination triggers chaos!'][Math.floor(Math.random() * 4)],
                    choices: [
                        { text: '‚öîÔ∏è Total war mobilization', effects: { stability: -20, innovation: -15, culture: -20, economy: -10 } },
                        { text: 'ü§ù Desperate diplomacy', effects: { stability: -15, innovation: -10, culture: -15, economy: -20 } },
                        { text: 'üèÉ Retreat and regroup', effects: { stability: -25, innovation: -5, culture: -10, economy: -25 } }
                    ]
                };
            }
            
            // 10% Lucky Break
            if (roll < 30) {
                return {
                    type: 'lucky',
                    title: '‚ú® GOLDEN OPPORTUNITY!',
                    description: ['Golden age begins!', 'Genius leader emerges!', 'Vast treasure discovered!', 'Diplomatic breakthrough achieved!'][Math.floor(Math.random() * 4)],
                    choices: [
                        { text: '‚öñÔ∏è Boost Stability', effects: { stability: 25, innovation: 0, culture: 0, economy: 0 } },
                        { text: '‚ö° Boost Innovation', effects: { stability: 0, innovation: 25, culture: 0, economy: 0 } },
                        { text: 'üé≠ Boost Culture', effects: { stability: 0, innovation: 0, culture: 25, economy: 0 } },
                        { text: 'üí∞ Boost Economy', effects: { stability: 0, innovation: 0, culture: 0, economy: 25 } }
                    ]
                };
            }
            
            return null;
        }

        // New: Stat decay system
        function applyStatDecay() {
            const { stability, innovation, culture, economy } = gameState;
            let decayMessage = [];
            
            // Critical decay if any stat < 20
            if (stability < 20) {
                gameState.stability = Math.max(0, stability - 3);
                gameState.innovation = Math.max(0, gameState.innovation - 2);
                decayMessage.push('‚öñÔ∏è Critical instability causing decay');
            }
            if (economy < 20) {
                gameState.economy = Math.max(0, economy - 3);
                gameState.stability = Math.max(0, gameState.stability - 2);
                gameState.culture = Math.max(0, gameState.culture - 2);
                gameState.innovation = Math.max(0, gameState.innovation - 2);
                decayMessage.push('üí∞ Poverty affecting all sectors');
            }
            if (innovation < 20) {
                gameState.innovation = Math.max(0, innovation - 2);
                decayMessage.push('‚ö° Stagnation spreading');
            }
            if (culture < 20) {
                gameState.culture = Math.max(0, culture - 2);
                gameState.stability = Math.max(0, gameState.stability - 1);
                decayMessage.push('üé≠ Cultural decay weakening society');
            }
            
            return decayMessage;
        }

        // New: Momentum system
        function calculateMomentum() {
            const { stability, innovation, culture, economy } = gameState;
            const allHealthy = stability > 40 && innovation > 40 && culture > 40 && economy > 40;
            
            if (allHealthy) {
                gameState.momentum = Math.min(20, gameState.momentum + 1);
                
                // Apply momentum bonus to all stats
                const bonus = Math.min(5, Math.floor(gameState.momentum / 3));
                if (bonus > 0) {
                    gameState.stability = Math.min(100, gameState.stability + bonus);
                    gameState.innovation = Math.min(100, gameState.innovation + bonus);
                    gameState.culture = Math.min(100, gameState.culture + bonus);
                    gameState.economy = Math.min(100, gameState.economy + bonus);
                    return { bonus: bonus, message: `üìà Momentum Bonus: +${bonus} to all stats!` };
                }
                return { bonus: 0, message: 'üìà Building momentum...' };
            } else {
                gameState.momentum = Math.max(0, gameState.momentum - 1);
                return { bonus: 0, message: gameState.momentum > 0 ? 'üìâ Momentum decreasing' : '' };
            }
        }

        // New: Prestige system
        function earnPrestige(totalImpact) {
            // Base prestige on impact magnitude and risk
            let prestigeEarned = Math.floor(totalImpact / 12);
            
            // Bonus prestige for high-risk choices (large negative effects)
            const hasHighRisk = Math.abs(Math.min(...Object.values(gameState.eventMemory[gameState.eventMemory.length - 1]?.effects || {}))) > 15;
            if (hasHighRisk) prestigeEarned += 1;
            
            // Difficulty multiplier
            const difficultyBonus = { normal: 1, hard: 1.3, nightmare: 1.7 };
            prestigeEarned = Math.floor(prestigeEarned * (difficultyBonus[gameState.difficulty] || 1));
            
            gameState.prestige += prestigeEarned;
            return prestigeEarned;
        }

        // New: Fetch additional APIs
        async function fetchRandomFact() {
            try {
                const response = await fetch('https://uselessfacts.jsph.pl/api/v2/facts/random');
                const data = await response.json();
                return data.text;
            } catch (error) {
                return null;
            }
        }

        async function fetchChuckNorrisJoke() {
            try {
                const response = await fetch('https://api.chucknorris.io/jokes/random');
                const data = await response.json();
                return data.value;
            } catch (error) {
                return null;
            }
        }

        function initializeRivals() {
            const rivalNames = [
                { name: 'Aurelia Empire', emoji: 'üëë', color: '#e74c3c' },
                { name: 'Nordheim Kingdom', emoji: '‚ö°', color: '#3498db' }
            ];
            
            // Rivals scale with difficulty - slightly weaker than player on average
            const difficultyMods = {
                normal: { base: 45, variance: 10 },
                hard: { base: 38, variance: 8 },
                nightmare: { base: 28, variance: 6 }
            };
            const mod = difficultyMods[gameState.difficulty] || difficultyMods.normal;
            
            gameState.rivals = rivalNames.map(rival => ({
                ...rival,
                stability: mod.base + Math.random() * mod.variance,
                innovation: mod.base + Math.random() * mod.variance,
                culture: mod.base + Math.random() * mod.variance,
                economy: mod.base + Math.random() * mod.variance,
                alive: true,
                relationship: 'neutral', // neutral, ally, war
                ai: true,
                personality: Math.random() > 0.5 ? 'aggressive' : 'defensive' // AI behavior type
            }));
        }

        function updateRivalsDisplay() {
            const rivalsList = document.getElementById('rivalsList');
            if (!rivalsList) return;
            
            // Update player score
            const playerTotal = gameState.stability + gameState.innovation + gameState.culture + gameState.economy;
            const playerTotalEl = document.getElementById('playerTotalScore');
            const playerLeaderNameEl = document.getElementById('playerLeaderName');
            const playerPowerBar = document.getElementById('playerPowerBar');
            const playerRankEmoji = document.getElementById('playerRankEmoji');
            
            if (playerTotalEl) playerTotalEl.textContent = Math.round(playerTotal);
            if (playerPowerBar) playerPowerBar.style.width = `${(playerTotal / 400) * 100}%`;
            
            // Show leader name
            if (playerLeaderNameEl && gameState.leader) {
                const leader = leaders[gameState.leader];
                if (leader) playerLeaderNameEl.textContent = leader.emoji + ' ' + leader.name;
            }
            
            // Calculate player rank
            const aliveRivals = gameState.rivals.filter(r => r.alive);
            const allScores = [playerTotal, ...aliveRivals.map(r => r.stability + r.innovation + r.culture + r.economy)];
            const sorted = [...allScores].sort((a, b) => b - a);
            const playerRank = sorted.indexOf(playerTotal) + 1;
            const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
            if (playerRankEmoji) playerRankEmoji.textContent = rankEmojis[playerRank - 1] || 'üìä';
            
            rivalsList.innerHTML = gameState.rivals.map((rival, idx) => {
                if (!rival.alive) return '<div style="padding: 10px; color: #999; font-style: italic;">üíÄ ' + rival.name + ' (Collapsed)</div>';
                const total = rival.stability + rival.innovation + rival.culture + rival.economy;
                const powerPercent = (total / 400) * 100;
                
                const rank = sorted.indexOf(total) + 1;
                const rankEmoji = rankEmojis[rank - 1] || 'üìä';
                
                const relationIcon = rival.relationship === 'ally' ? 'ü§ù' : rival.relationship === 'war' ? '‚öîÔ∏è' : 'ü§∑';
                
                return `
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${rival.color};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <span style="font-size: 1.2em;">${rival.emoji}</span>
                                <strong>${rival.name}</strong>
                                <span style="margin-left: 8px;">${relationIcon}</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="font-size: 1.3em;">${rankEmoji}</span>
                                <div style="font-size: 0.9em; color: #999;">Power: ${Math.round(total)}</div>
                            </div>
                        </div>
                        <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
                            <div style="width: ${powerPercent}%; background: ${rival.color}; height: 100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function rivalTurn(rival) {
            if (!rival || !rival.alive) return;
            
            const stats = ['stability', 'innovation', 'culture', 'economy'];
            const changes = [];
            
            // Smarter AI: prioritize weakest stats
            stats.forEach(stat => {
                const value = rival[stat];
                let change;
                
                if (value < 25) {
                    // Critical - strong recovery attempt
                    change = 4 + Math.random() * 6;
                } else if (value < 40) {
                    // Low - moderate recovery
                    change = 2 + Math.random() * 4;
                } else if (value > 70) {
                    // High - risky moves
                    change = (Math.random() - 0.5) * 10;
                } else {
                    // Balanced - slight improvements
                    change = (Math.random() - 0.3) * 6;
                }
                
                // Personality affects behavior
                if (rival.personality === 'aggressive') {
                    change = change * 1.3; // More volatile
                } else {
                    change = change * 0.8; // More conservative
                }
                
                changes.push(change);
            });
            
            stats.forEach((stat, idx) => {
                if (rival[stat] !== undefined) {
                    rival[stat] = Math.max(0, Math.min(100, rival[stat] + changes[idx]));
                }
            });
            
            // Check for rival collapse
            if (rival.stability <= 0 || rival.economy <= 0) {
                rival.alive = false;
                showMessage(`üíÄ ${rival.name} has collapsed!`, 'info');
            }
        }

        function checkDiplomaticPhase() {
            return gameState.turn > 0 && gameState.turn % 3 === 0;
        }

        function showDiplomaticPhase() {
            const modal = document.getElementById('diplomaticModal');
            const choicesDiv = document.getElementById('diplomaticChoices');
            
            modal.classList.add('show');
            
            const aliveRivals = gameState.rivals.filter(r => r.alive);
            if (aliveRivals.length === 0) {
                modal.classList.remove('show');
                return;
            }
            
            const isDark = document.body.classList.contains('dark-mode');
            const bgColor = isDark ? '#1a1a2e' : '#f5f5f5';
            const textColor = isDark ? '#e0e0e0' : '#333';
            
            choicesDiv.innerHTML = aliveRivals.map((rival, idx) => {
                // Get the actual index in the full rivals array
                const realIdx = gameState.rivals.indexOf(rival);
                return `
                <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; border-left: 4px solid ${rival.color}; margin-bottom: 15px;">
                    <h4 style="color: ${textColor}; margin-bottom: 10px;">${rival.emoji} ${rival.name} - ${rival.relationship.toUpperCase()}</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <button onclick="diplomaticAction(${realIdx}, 'trade')" class="choice-btn" style="padding: 10px; font-size: 0.9em; background: #667eea; color: white; border: none; cursor: pointer; border-radius: 4px;">ü§ù Trade Deal<br><small>+10 Econ both</small></button>
                        <button onclick="diplomaticAction(${realIdx}, 'culture')" class="choice-btn" style="padding: 10px; font-size: 0.9em; background: #667eea; color: white; border: none; cursor: pointer; border-radius: 4px;">üé≠ Cultural Exchange<br><small>+10 Culture both</small></button>
                        <button onclick="diplomaticAction(${realIdx}, 'ally')" class="choice-btn" style="padding: 10px; font-size: 0.9em; background: #51cf66; color: white; border: none; cursor: pointer; border-radius: 4px;">ü§ù Form Alliance<br><small>Mutual protection</small></button>
                        <button onclick="diplomaticAction(${realIdx}, 'war')" class="choice-btn" style="padding: 10px; font-size: 0.9em; background: #ff6b6b; color: white; border: none; cursor: pointer; border-radius: 4px;">‚öîÔ∏è Declare War<br><small>High risk/reward</small></button>
                    </div>
                </div>
            `}).join('') + `
                <button onclick="closeDiplomaticPhase()" class="btn" style="margin-top: 15px; width: 100%;">Continue Without Action</button>
            `;
        }

        function diplomaticAction(rivalIdx, action) {
            const rival = gameState.rivals[rivalIdx];
            if (!rival || !rival.alive) return;
            
            switch(action) {
                case 'trade':
                    gameState.economy = Math.min(100, gameState.economy + 10);
                    rival.economy = Math.min(100, rival.economy + 10);
                    rival.relationship = 'ally';
                    showMessage(`üì¶ Trade agreement with ${rival.name}!`, 'success');
                    break;
                    
                case 'culture':
                    gameState.culture = Math.min(100, gameState.culture + 10);
                    rival.culture = Math.min(100, rival.culture + 10);
                    rival.relationship = 'ally';
                    showMessage(`üé≠ Cultural exchange with ${rival.name}!`, 'success');
                    break;
                    
                case 'ally':
                    rival.relationship = 'ally';
                    gameState.stability = Math.min(100, gameState.stability + 5);
                    showMessage(`ü§ù Alliance formed with ${rival.name}!`, 'success');
                    break;
                    
                case 'war':
                    rival.relationship = 'war';
                    gameState.warWith.push(rivalIdx);
                    const playerPower = gameState.stability + gameState.innovation + gameState.economy;
                    const rivalPower = rival.stability + rival.innovation + rival.economy;
                    
                    if (playerPower > rivalPower * 1.2) {
                        // Victory
                        gameState.stability = Math.max(0, gameState.stability - 10);
                        gameState.economy += 15;
                        gameState.prestige += 5;
                        rival.alive = false;
                        showMessage(`‚öîÔ∏è Victory over ${rival.name}! +15 Economy, +5 Prestige`, 'success');
                    } else if (playerPower > rivalPower) {
                        // Narrow victory
                        gameState.stability = Math.max(0, gameState.stability - 15);
                        gameState.economy += 5;
                        rival.stability = Math.max(0, rival.stability - 20);
                        showMessage(`‚öîÔ∏è Costly victory over ${rival.name}`, 'info');
                    } else {
                        // Defeat
                        gameState.stability = Math.max(0, gameState.stability - 25);
                        gameState.economy = Math.max(0, gameState.economy - 20);
                        showMessage(`üíÄ Defeated by ${rival.name}! Heavy losses!`, 'error');
                    }
                    break;
            }
            
            updateStats();
            updateRivalsDisplay();
            
            // Set flag and close modal
            gameState.diplomaticActionTaken = true;
            closeDiplomaticPhase();
            setTimeout(() => displayEvent(), 500);
        }

        function closeDiplomaticPhase() {
            document.getElementById('diplomaticModal').classList.remove('show');
            gameState.diplomaticPhase = false;
            // displayEvent will be called by either diplomaticAction or manually if no action taken
            // If closing without action, advance the game
            if (!gameState.diplomaticActionTaken) {
                setTimeout(() => displayEvent(), 500);
            }
            gameState.diplomaticActionTaken = false; // Reset flag
        }

        function useLeaderAction() {
            if (gameState.leaderActionUsed) {
                showMessage('Leader action already used!', 'error');
                return;
            }
            
            const leader = leaders[gameState.leader];
            gameState.leaderActionUsed = true;
            document.getElementById('leaderActionBtn').disabled = true;
            document.getElementById('leaderActionBtn').style.opacity = '0.5';
            document.getElementById('leaderActionBtn').textContent = '‚úì Used';
            
            switch(gameState.leader) {
                case 'conqueror':
                    // Declare war with bonus
                    const target = gameState.rivals.find(r => r.alive);
                    if (target) {
                        target.alive = false;
                        gameState.stability += 15;
                        gameState.innovation += 15;
                        gameState.culture += 15;
                        gameState.economy += 15;
                        showMessage(`‚öîÔ∏è Conquered ${target.name}! +15 to all stats!`, 'success');
                    }
                    break;
                    
                case 'scholar':
                    gameState.innovation += 20;
                    gameState.culture += 10;
                    showMessage('üí° Eureka Moment! +20 Innovation, +10 Culture', 'success');
                    break;
                    
                case 'diplomat':
                    gameState.rivals.forEach(r => r.relationship = 'ally');
                    gameState.warWith = [];
                    gameState.stability += 10;
                    gameState.culture += 10;
                    gameState.economy += 10;
                    gameState.innovation += 10;
                    showMessage('üïäÔ∏è Peace Summit! All rivals now allies! +10 to all stats', 'success');
                    break;
                    
                case 'merchant':
                    gameState.economy += 30;
                    gameState.prestige += 10;
                    showMessage('üí∞ Golden Age! +30 Economy, +10 Prestige', 'success');
                    break;
                    
                case 'revolutionary':
                    gameState.stability = 50;
                    gameState.innovation = 50;
                    gameState.culture = 50;
                    gameState.economy = 50;
                    gameState.prestige += 20;
                    showMessage('üî• Revolution! All stats reset to 50, +20 Prestige', 'success');
                    break;
            }
            
            updateStats();
            updateRivalsDisplay();
        }

        function applyLeaderPassive() {
            if (!gameState.leader || !leaders[gameState.leader]) return;
            
            const leader = leaders[gameState.leader];
            
            // Apply bonuses
            if (leader.bonuses) {
                Object.entries(leader.bonuses).forEach(([stat, value]) => {
                    if (gameState[stat] !== undefined) {
                        gameState[stat] = Math.min(100, gameState[stat] + value);
                    }
                });
            }
            
            // Apply penalties
            if (leader.penalties) {
                Object.entries(leader.penalties).forEach(([stat, value]) => {
                    if (gameState[stat] !== undefined) {
                        gameState[stat] = Math.max(0, gameState[stat] + value);
                    }
                });
            }
        }

        function showMessage(text, type) {
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.textContent = text;
            apiStatus.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
            apiStatus.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
            
            setTimeout(() => {
                apiStatus.style.background = '';
                apiStatus.style.color = '';
            }, 3000);
        }

        function startGame(difficulty = 'normal') {
            if (!selectedLeader) {
                alert('‚ö†Ô∏è Please select a leader first!');
                document.getElementById('difficultySelection').style.display = 'none';
                document.getElementById('leaderSelection').style.display = 'block';
                return;
            }
            
            const startValues = {
                normal: 50,
                hard: 40,
                nightmare: 30
            };
            
            const start = startValues[difficulty] || 50;
            
            // Reset entire game state
            gameState.turn = 0;
            gameState.difficulty = difficulty;
            gameState.leader = selectedLeader;
            gameState.leaderActionUsed = false;
            gameState.warWith = [];
            gameState.gameOver = false;
            gameState.prestige = 0;
            gameState.momentum = 0;
            gameState.decisions = [];
            gameState.eventMemory = [];
            gameState.diplomaticPhase = false;
            gameState.diplomaticActionTaken = false;
            gameState.stability = start;
            gameState.innovation = start;
            gameState.culture = start;
            gameState.economy = start;
            
            // Apply leader starting bonuses
            const leader = leaders[selectedLeader];
            Object.entries(leader.startBonus).forEach(([stat, value]) => {
                if (gameState[stat] !== undefined) {
                    gameState[stat] = Math.min(100, gameState[stat] + value);
                }
            });
            
            // Initialize rivals
            initializeRivals();
            
            document.getElementById('introModal').style.display = 'none';
            
            // Show leader display
            const leaderDisplay = document.getElementById('leaderDisplay');
            if (leaderDisplay) {
                leaderDisplay.style.display = 'block';
                document.getElementById('leaderEmoji').textContent = leader.emoji;
                document.getElementById('leaderName').textContent = leader.name;
                
                // Show both bonuses and penalties
                const effects = [];
                Object.entries(leader.bonuses).forEach(([stat, val]) => {
                    effects.push(`+${val} ${stat.charAt(0).toUpperCase() + stat.slice(1)}`);
                });
                Object.entries(leader.penalties).forEach(([stat, val]) => {
                    effects.push(`${val} ${stat.charAt(0).toUpperCase() + stat.slice(1)}`);
                });
                
                document.getElementById('leaderBonus').textContent = effects.length > 0 ? effects.join(', ') : 'Balanced';
            }
            
            // Show rivals display
            const rivalsDisplay = document.getElementById('rivalsDisplay');
            if (rivalsDisplay) {
                rivalsDisplay.style.display = 'block';
            }
            
            updateStats();
            updateRivalsDisplay();
            
            // Show leader action button
            const leaderActionBtn = document.getElementById('leaderActionBtn');
            if (leaderActionBtn) {
                leaderActionBtn.style.display = 'block';
                leaderActionBtn.textContent = `‚ö° ${leader.emoji} ${leader.special.split('(')[0]}`;
            }
            
            displayEvent();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDark);
            document.querySelector('.theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        if (localStorage.getItem('dark-mode') === 'true') {
            document.body.classList.add('dark-mode');
            document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        async function fetchWikipediaSummary(topic) {
            try {
                const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${topic}`);
                if (!response.ok) return null;
                const data = await response.json();
                return data.extract;
            } catch (error) {
                console.error('Wikipedia API error:', error);
                return null;
            }
        }

        async function fetchHistoricalQuote() {
            try {
                const response = await fetch('https://api.adviceslip.com/advice');
                const data = await response.json();
                return `"${data.slip.advice}"`;
            } catch (error) {
                try {
                    const response = await fetch('https://api.gameofthronesquotes.xyz/v1/random');
                    const data = await response.json();
                    return `"${data.sentence}" - ${data.character.name}`;
                } catch (e) {
                    return null;
                }
            }
        }

        function getEventTemplates(era) {
            const { stability, innovation, culture, economy } = gameState;
            const templates = [];

            // Crisis events if any stat is low
            if (stability < 30) {
                templates.push({
                    title: `‚ö†Ô∏è ${era.name}: Social Unrest`,
                    situation: 'Your civilization teeters on the brink of chaos. Riots and disorder spread. How will you restore order?',
                    choices: [
                        { text: '‚öîÔ∏è Enforce martial law', effects: { stability: 25, innovation: -10, culture: -15, economy: -10 } },
                        { text: 'ü§ù Negotiate with leaders', effects: { stability: 15, innovation: 0, culture: 10, economy: -5 } },
                        { text: 'üìú Reform institutions', effects: { stability: 10, innovation: 10, culture: 5, economy: -15 } }
                    ]
                });
            }

            if (economy < 30) {
                templates.push({
                    title: `üí∞ ${era.name}: Economic Crisis`,
                    situation: 'Your economy is in freefall. Trade has collapsed, unemployment soars, and famine looms.',
                    choices: [
                        { text: 'üíµ Print more currency', effects: { stability: -10, innovation: 0, culture: -5, economy: 20 } },
                        { text: 'üè¶ Seek foreign loans', effects: { stability: 5, innovation: -5, culture: 0, economy: 25 } },
                        { text: 'üåæ Focus on agriculture', effects: { stability: 10, innovation: -10, culture: -5, economy: 15 } }
                    ]
                });
            }

            if (innovation < 30) {
                templates.push({
                    title: `üî¨ ${era.name}: Stagnation Crisis`,
                    situation: 'Your civilization has fallen behind. Other nations surpass you in every field. Innovation is needed now!',
                    choices: [
                        { text: 'üéì Build universities', effects: { stability: -5, innovation: 25, culture: 15, economy: -15 } },
                        { text: 'üïµÔ∏è Steal foreign tech', effects: { stability: -15, innovation: 20, culture: -10, economy: 5 } },
                        { text: 'üí° Incentivize inventors', effects: { stability: 0, innovation: 15, culture: 5, economy: -10 } }
                    ]
                });
            }

            if (culture < 30) {
                templates.push({
                    title: `üé≠ ${era.name}: Cultural Decay`,
                    situation: 'Your people have lost their identity. Traditions fade, morale plummets, and purpose disappears.',
                    choices: [
                        { text: 'üèõÔ∏è Build monuments', effects: { stability: 10, innovation: -10, culture: 25, economy: -15 } },
                        { text: 'üé® Support artists', effects: { stability: -5, innovation: 5, culture: 20, economy: -10 } },
                        { text: 'üìö Preserve traditions', effects: { stability: 15, innovation: -15, culture: 20, economy: 0 } }
                    ]
                });
            }

            // Normal balanced events
            templates.push(
                {
                    title: `‚öîÔ∏è ${era.name}: Military Conflict`,
                    situation: 'A neighboring power threatens your borders. Prepare for war or seek peace?',
                    choices: [
                        { text: '‚öîÔ∏è Launch preemptive strike', effects: { stability: -20, innovation: 10, culture: -10, economy: -15 } },
                        { text: 'üõ°Ô∏è Fortify defenses', effects: { stability: 10, innovation: -5, culture: 0, economy: -10 } },
                        { text: 'ü§ù Negotiate alliance', effects: { stability: 5, innovation: 5, culture: 10, economy: 10 } }
                    ]
                },
                {
                    title: `üî¨ ${era.name}: Technological Discovery`,
                    situation: 'Your scientists have made a breakthrough! How will you apply this new knowledge?',
                    choices: [
                        { text: '‚öôÔ∏è Industrialize rapidly', effects: { stability: -10, innovation: 20, culture: -5, economy: 15 } },
                        { text: 'üìñ Share with the world', effects: { stability: 5, innovation: 15, culture: 15, economy: -5 } },
                        { text: 'üîí Keep it secret', effects: { stability: 0, innovation: 10, culture: -10, economy: 20 } }
                    ]
                },
                {
                    title: `üìú ${era.name}: Social Movement`,
                    situation: 'A powerful social movement demands radical change. Revolutionary ideas spread like wildfire.',
                    choices: [
                        { text: '‚úä Embrace the revolution', effects: { stability: -15, innovation: 15, culture: 20, economy: -10 } },
                        { text: '‚öñÔ∏è Gradual reforms', effects: { stability: 5, innovation: 10, culture: 10, economy: 0 } },
                        { text: 'üõë Maintain status quo', effects: { stability: 15, innovation: -15, culture: -20, economy: 10 } }
                    ]
                },
                {
                    title: `üåæ ${era.name}: Resource Discovery`,
                    situation: 'Vast natural resources have been discovered! How will you exploit them?',
                    choices: [
                        { text: '‚ö° Rapid extraction', effects: { stability: -10, innovation: 10, culture: -5, economy: 25 } },
                        { text: '‚ôªÔ∏è Sustainable approach', effects: { stability: 10, innovation: 15, culture: 10, economy: 10 } },
                        { text: 'üèûÔ∏è Preserve nature', effects: { stability: 5, innovation: -10, culture: 20, economy: -5 } }
                    ]
                },
                {
                    title: `üé≠ ${era.name}: Cultural Renaissance`,
                    situation: 'Artists and thinkers are creating unprecedented works. Support them or focus elsewhere?',
                    choices: [
                        { text: 'üé® Massive patronage', effects: { stability: 0, innovation: 10, culture: 25, economy: -15 } },
                        { text: 'üìö Build institutions', effects: { stability: 10, innovation: 5, culture: 15, economy: -10 } },
                        { text: 'üí∞ Focus on economy', effects: { stability: -5, innovation: 0, culture: -15, economy: 20 } }
                    ]
                },
                {
                    title: `üèõÔ∏è ${era.name}: Political Crisis`,
                    situation: 'The government system is outdated. Reform your institutions or risk collapse?',
                    choices: [
                        { text: 'üó≥Ô∏è Democracy now!', effects: { stability: -15, innovation: 15, culture: 15, economy: -5 } },
                        { text: 'üëë Strengthen monarchy', effects: { stability: 15, innovation: -10, culture: 5, economy: 5 } },
                        { text: '‚öñÔ∏è Mixed system', effects: { stability: 5, innovation: 5, culture: 5, economy: 5 } }
                    ]
                }
            );

            // Opportunity events if stats are high
            if (innovation > 70) {
                templates.push({
                    title: `üöÄ ${era.name}: Golden Age of Innovation`,
                    situation: 'Your civilization leads the world in technology! Capitalize on this advantage.',
                    choices: [
                        { text: 'üè≠ Industrial supremacy', effects: { stability: -10, innovation: 15, culture: -10, economy: 25 } },
                        { text: 'üåç Spread knowledge', effects: { stability: 10, innovation: 10, culture: 20, economy: 10 } },
                        { text: '‚öîÔ∏è Military technology', effects: { stability: 5, innovation: 10, culture: -15, economy: 10 } }
                    ]
                });
            }

            if (culture > 70) {
                templates.push({
                    title: `üé≠ ${era.name}: Cultural Golden Age`,
                    situation: 'Your civilization is the beacon of art and philosophy! How will you use this soft power?',
                    choices: [
                        { text: 'üåç Cultural imperialism', effects: { stability: 5, innovation: 0, culture: 15, economy: 15 } },
                        { text: 'üìö Preserve heritage', effects: { stability: 15, innovation: -10, culture: 20, economy: 0 } },
                        { text: 'üé® Export culture', effects: { stability: 0, innovation: 10, culture: 10, economy: 20 } }
                    ]
                });
            }

            if (economy > 70 && stability > 70) {
                templates.push({
                    title: `üíé ${era.name}: Age of Prosperity`,
                    situation: 'Your civilization enjoys unprecedented wealth and peace. Invest wisely!',
                    choices: [
                        { text: 'üèóÔ∏è Monumental projects', effects: { stability: 10, innovation: 5, culture: 20, economy: -10 } },
                        { text: 'üéì Universal education', effects: { stability: 5, innovation: 20, culture: 15, economy: -15 } },
                        { text: 'üí∞ Build reserves', effects: { stability: 15, innovation: -5, culture: 0, economy: 15 } }
                    ]
                });
            }

            // Diplomatic events
            templates.push(
                {
                    title: `ü§ù ${era.name}: Foreign Envoy`,
                    situation: 'A powerful empire offers an alliance. They want trade rights and military cooperation.',
                    choices: [
                        { text: 'ü§ù Full alliance', effects: { stability: 10, innovation: 5, culture: -10, economy: 15 } },
                        { text: 'üíº Trade only', effects: { stability: 0, innovation: 0, culture: 5, economy: 15 } },
                        { text: 'üö´ Refuse all terms', effects: { stability: -10, innovation: 0, culture: 15, economy: -10 } }
                    ]
                },
                {
                    title: `üïµÔ∏è ${era.name}: Espionage Discovered`,
                    situation: 'Foreign spies have been caught stealing secrets. How will you respond?',
                    choices: [
                        { text: '‚öîÔ∏è Declare war', effects: { stability: -20, innovation: -10, culture: -10, economy: -15 } },
                        { text: 'üé≠ Public execution', effects: { stability: 10, innovation: -5, culture: -15, economy: -5 } },
                        { text: 'ü§ê Secret negotiations', effects: { stability: 0, innovation: 10, culture: 5, economy: 10 } }
                    ]
                },
                {
                    title: `üåä ${era.name}: Refugee Crisis`,
                    situation: 'Thousands flee from war-torn lands, seeking refuge in your civilization.',
                    choices: [
                        { text: 'ü§ó Welcome all refugees', effects: { stability: -15, innovation: 10, culture: 20, economy: -10 } },
                        { text: '‚öñÔ∏è Selective admission', effects: { stability: 0, innovation: 5, culture: 5, economy: 0 } },
                        { text: 'üöß Close borders', effects: { stability: 10, innovation: -10, culture: -20, economy: 5 } }
                    ]
                }
            );

            // Factional events
            templates.push(
                {
                    title: `‚öîÔ∏è ${era.name}: Military Coup Attempt`,
                    situation: 'Ambitious generals plot to seize power. Your intelligence network has uncovered their plan.',
                    choices: [
                        { text: 'üó°Ô∏è Purge the military', effects: { stability: -20, innovation: 0, culture: -10, economy: -10 } },
                        { text: 'üí∞ Buy their loyalty', effects: { stability: 5, innovation: -5, culture: -10, economy: -20 } },
                        { text: 'üéØ Promote them', effects: { stability: 10, innovation: -10, culture: 0, economy: 5 } }
                    ]
                },
                {
                    title: `üè≠ ${era.name}: Workers' Strike`,
                    situation: 'Industrial workers demand better conditions. Production has halted across the nation.',
                    choices: [
                        { text: '‚úä Meet all demands', effects: { stability: 15, innovation: -5, culture: 10, economy: -20 } },
                        { text: '‚öñÔ∏è Compromise solution', effects: { stability: 5, innovation: 0, culture: 5, economy: -10 } },
                        { text: '‚öîÔ∏è Break the strike', effects: { stability: -20, innovation: 5, culture: -15, economy: 10 } }
                    ]
                },
                {
                    title: `üéì ${era.name}: Academic Rebellion`,
                    situation: 'Students and intellectuals challenge traditional authority. New ideas threaten the old order.',
                    choices: [
                        { text: 'üìö Support free thought', effects: { stability: -10, innovation: 20, culture: 15, economy: -5 } },
                        { text: '‚öñÔ∏è Regulated discourse', effects: { stability: 5, innovation: 10, culture: 5, economy: 0 } },
                        { text: 'üîí Suppress dissent', effects: { stability: 15, innovation: -20, culture: -15, economy: 5 } }
                    ]
                }
            );

            // Ideological events
            templates.push(
                {
                    title: `‚õ™ ${era.name}: Religious Schism`,
                    situation: 'A new religious movement splits your society. Heresy or enlightenment?',
                    choices: [
                        { text: '‚õ™ Support orthodoxy', effects: { stability: 10, innovation: -15, culture: -10, economy: 0 } },
                        { text: 'üïäÔ∏è Religious tolerance', effects: { stability: -5, innovation: 10, culture: 15, economy: 5 } },
                        { text: 'üèõÔ∏è Secular government', effects: { stability: -15, innovation: 15, culture: -5, economy: 10 } }
                    ]
                },
                {
                    title: `üìú ${era.name}: Constitutional Crisis`,
                    situation: 'The fundamental laws of your land are questioned. Rewrite the social contract?',
                    choices: [
                        { text: 'üó≥Ô∏è Radical democracy', effects: { stability: -20, innovation: 15, culture: 20, economy: -10 } },
                        { text: '‚öñÔ∏è Balanced reform', effects: { stability: 5, innovation: 5, culture: 10, economy: 0 } },
                        { text: 'üëë Traditional order', effects: { stability: 15, innovation: -15, culture: -10, economy: 10 } }
                    ]
                },
                {
                    title: `üåê ${era.name}: Globalization Debate`,
                    situation: 'Trade and cultural exchange accelerate. Embrace the world or protect your identity?',
                    choices: [
                        { text: 'üåç Full integration', effects: { stability: -10, innovation: 20, culture: -15, economy: 25 } },
                        { text: '‚öñÔ∏è Selective opening', effects: { stability: 5, innovation: 10, culture: 5, economy: 10 } },
                        { text: 'üõ°Ô∏è Isolationism', effects: { stability: 15, innovation: -20, culture: 20, economy: -15 } }
                    ]
                }
            );

            // Extreme events for late game (turns 7+)
            if (gameState.turn >= 7) {
                templates.push(
                    {
                        title: `‚ò¢Ô∏è ${era.name}: ULTIMATE CRISIS`,
                        situation: '‚ö†Ô∏è ENDGAME CRISIS ‚ö†Ô∏è\nYour civilization faces its greatest challenge. This decision will define your legacy forever.',
                        choices: [
                            { text: '‚ö° ALL IN - Maximum risk!', effects: { stability: -30, innovation: 30, culture: -20, economy: 30 } },
                            { text: 'üõ°Ô∏è DEFEND - Preserve what remains', effects: { stability: 20, innovation: -20, culture: 20, economy: -20 } },
                            { text: '‚öñÔ∏è BALANCE - Measured response', effects: { stability: 10, innovation: 10, culture: 10, economy: 10 } }
                        ]
                    },
                    {
                        title: `üåü ${era.name}: Final Transcendence`,
                        situation: 'Your civilization stands at the precipice of transformation. Will you ascend to greatness or fall to hubris?',
                        choices: [
                            { text: 'üöÄ Leap into the unknown', effects: { stability: -25, innovation: 35, culture: 15, economy: -15 } },
                            { text: 'üìö Preserve wisdom', effects: { stability: 15, innovation: -10, culture: 30, economy: 10 } },
                            { text: 'üí∞ Consolidate power', effects: { stability: 10, innovation: -15, culture: -10, economy: 30 } }
                        ]
                    }
                );
            }

            // Progressive difficulty - double penalties on turns 7-10
            if (gameState.turn >= 7) {
                templates.forEach(template => {
                    template.choices.forEach(choice => {
                        Object.keys(choice.effects).forEach(stat => {
                            if (choice.effects[stat] < 0) {
                                choice.effects[stat] *= 1.5; // 50% more penalties in late game
                            }
                        });
                    });
                });
            }

            return templates;
        }

        // Prestige spending powers
        let prestigeEffectActive = null;

        function usePrestigeReroll() {
            if (gameState.prestige < 5) return;
            gameState.prestige -= 5;
            updateStats();
            displayEvent(); // Regenerate new choices
        }

        function usePrestigeShield() {
            if (gameState.prestige < 8) return;
            gameState.prestige -= 8;
            prestigeEffectActive = 'shield';
            updateStats();
            alert('üõ°Ô∏è Shield activated! Your next choice will ignore all negative effects!');
        }

        function usePrestigeBoost() {
            if (gameState.prestige < 12) return;
            gameState.prestige -= 12;
            prestigeEffectActive = 'boost';
            updateStats();
            alert('‚ö° Boost activated! Your next choice will have doubled positive effects!');
        }

        async function generateEvent() {
            const era = eras[gameState.turn % eras.length];
            gameState.currentEra = era;

            try {
                document.getElementById('apiStatus').textContent = 'üîÑ Consulting historical records...';
                
                const templates = getEventTemplates(era);
                const template = templates[Math.floor(Math.random() * templates.length)];
                
                // 15% chance to add Chuck Norris humor
                const addChuckNorris = Math.random() < 0.15;
                
                const apiCalls = [
                    fetchWikipediaSummary(era.wikiTopic),
                    fetchHistoricalQuote()
                ];
                
                if (addChuckNorris) {
                    apiCalls.push(fetchChuckNorrisJoke());
                }
                
                const results = await Promise.all(apiCalls);
                const wikiSummary = results[0];
                const quote = results[1];
                const chuckJoke = addChuckNorris ? results[2] : null;

                let description = `üìç ${era.period}\n\n${template.situation}\n\n`;
                
                if (wikiSummary) {
                    description += `üìö Historical Context: ${wikiSummary.substring(0, 180)}...\n\n`;
                }
                
                if (quote) {
                    description += `üí≠ "${quote}"\n\n`;
                }
                
                if (chuckJoke) {
                    description += `ü•ã Meanwhile: ${chuckJoke}\n\n`;
                }

                document.getElementById('apiStatus').textContent = `‚úÖ Historical data loaded from ${era.name}`;
                
                return {
                    title: template.title,
                    description: description,
                    choices: template.choices
                };
            } catch (error) {
                console.error('Event generation error:', error);
                document.getElementById('apiStatus').textContent = '‚ö†Ô∏è Using offline historical data';
                
                const templates = getEventTemplates(era);
                const template = templates[0];
                
                return {
                    title: template.title,
                    description: `üìç ${era.period}\n\n${template.situation}`,
                    choices: template.choices
                };
            }
        }

        async function displayEvent() {
            if (gameState.turn >= gameState.maxTurns) {
                endGame(true);
                return;
            }

            // Check for random events first
            const randomEvent = checkRandomEvents();
            if (randomEvent) {
                displayRandomEvent(randomEvent);
                return;
            }

            const event = await generateEvent();
            
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventDescription').textContent = event.description;
            document.getElementById('consequences').style.display = 'none';

            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';
            
            // Add prestige spending options if player has enough
            if (gameState.prestige >= 5) {
                const prestigeHeader = document.createElement('div');
                prestigeHeader.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; margin-bottom: 15px; border-radius: 8px; text-align: center;';
                prestigeHeader.innerHTML = `
                    <div style="color: white; font-weight: bold; margin-bottom: 10px;">üíé PRESTIGE POWERS (${gameState.prestige} points available)</div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        ${gameState.prestige >= 5 ? '<button onclick="usePrestigeReroll()" style="padding: 8px 15px; background: #ffd700; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">üé≤ Reroll Choices (5üíé)</button>' : ''}
                        ${gameState.prestige >= 8 ? '<button onclick="usePrestigeShield()" style="padding: 8px 15px; background: #4CAF50; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">üõ°Ô∏è Negate Penalties (8üíé)</button>' : ''}
                        ${gameState.prestige >= 12 ? '<button onclick="usePrestigeBoost()" style="padding: 8px 15px; background: #ff6b6b; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">‚ö° Double Bonuses (12üíé)</button>' : ''}
                    </div>
                `;
                choicesContainer.appendChild(prestigeHeader);
            }
            
            event.choices.forEach((choice) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                const effectsText = Object.entries(choice.effects)
                    .map(([stat, val]) => `${stat.charAt(0).toUpperCase() + stat.slice(1)} ${val > 0 ? '+' : ''}${val}`)
                    .join(', ');
                btn.innerHTML = `<strong>${choice.text}</strong><br><span style="font-size: 0.85em; opacity: 0.9;">üìä ${effectsText}</span>`;
                btn.onclick = () => makeChoice(choice);
                choicesContainer.appendChild(btn);
            });
        }

        function displayRandomEvent(event) {
            document.getElementById('apiStatus').textContent = `‚ö†Ô∏è ${event.type === 'lucky' ? 'LUCKY BREAK' : 'CRISIS'} EVENT!`;
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventDescription').textContent = event.description + '\n\nThis unexpected event requires immediate action!';
            document.getElementById('consequences').style.display = 'none';

            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';
            
            event.choices.forEach((choice) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                const effectsText = Object.entries(choice.effects)
                    .map(([stat, val]) => `${stat.charAt(0).toUpperCase() + stat.slice(1)} ${val > 0 ? '+' : ''}${val}`)
                    .join(', ');
                btn.innerHTML = `<strong>${choice.text}</strong><br><span style="font-size: 0.85em; opacity: 0.9;">üìä ${effectsText}</span>`;
                btn.onclick = () => makeChoice(choice, true);
                choicesContainer.appendChild(btn);
            });
        }

        function updateStats() {
            document.getElementById('stabilityDisplay').textContent = gameState.stability;
            document.getElementById('innovationDisplay').textContent = gameState.innovation;
            document.getElementById('cultureDisplay').textContent = gameState.culture;
            document.getElementById('economyDisplay').textContent = gameState.economy;
            document.getElementById('prestigeDisplay').textContent = gameState.prestige;
            document.getElementById('momentumDisplay').textContent = gameState.momentum;
            
            const progress = (gameState.turn / gameState.maxTurns) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').textContent = `Turn ${gameState.turn}/${gameState.maxTurns}`;
            
            ['stability', 'innovation', 'culture', 'economy'].forEach(stat => {
                const elem = document.getElementById(stat + 'Display');
                const val = gameState[stat];
                if (val < 20) elem.style.color = '#ff4444';
                else if (val < 40) elem.style.color = '#ff9944';
                else if (val > 70) elem.style.color = '#44ff44';
                else elem.style.color = '#667eea';
            });
        }

        function makeChoice(choice, isRandomEvent = false) {
            gameState.turn++;
            
            // Apply leader passive bonuses
            applyLeaderPassive();
            
            // Rivals take their turns
            gameState.rivals.forEach(rival => rivalTurn(rival));
            
            // Apply prestige effects
            let modifiedEffects = { ...choice.effects };
            
            if (prestigeEffectActive === 'shield') {
                // Remove all negative effects
                Object.keys(modifiedEffects).forEach(stat => {
                    if (modifiedEffects[stat] < 0) modifiedEffects[stat] = 0;
                });
                prestigeEffectActive = null;
            } else if (prestigeEffectActive === 'boost') {
                // Double all positive effects
                Object.keys(modifiedEffects).forEach(stat => {
                    if (modifiedEffects[stat] > 0) modifiedEffects[stat] *= 2;
                });
                prestigeEffectActive = null;
            }
            
            // Apply choice effects
            Object.entries(modifiedEffects).forEach(([stat, value]) => {
                gameState[stat] = Math.max(0, Math.min(100, gameState[stat] + value));
            });
            
            // Earn prestige from difficult choices (high impact decisions)
            const totalImpact = Object.values(modifiedEffects).reduce((sum, val) => sum + Math.abs(val), 0);
            const prestigeEarned = earnPrestige(totalImpact);
            
            // Apply stat decay (penalties for struggling stats)
            const decayMessages = applyStatDecay();
            
            // Calculate momentum bonus/penalty
            const momentumResult = calculateMomentum();
            
            // Store event in memory for consequence chains
            gameState.eventMemory.push({
                turn: gameState.turn,
                choice: choice.text,
                effects: modifiedEffects
            });
            if (gameState.eventMemory.length > 5) gameState.eventMemory.shift(); // Keep last 5 events
            
            gameState.decisions.push({
                era: gameState.currentEra?.name || 'Unknown Era',
                turn: gameState.turn,
                choice: choice.text,
                effects: modifiedEffects
            });

            updateStats();
            
            // Check for collapse
            const { stability, innovation, culture, economy } = gameState;
            let collapseReason = null;
            
            if (stability <= 0) collapseReason = '‚öñÔ∏è Stability collapsed - social chaos consumed your civilization';
            else if (innovation <= 0) collapseReason = '‚ö° Innovation died - stagnation led to irrelevance';
            else if (culture <= 0) collapseReason = 'üé≠ Culture withered - your people lost all sense of purpose';
            else if (economy <= 0) collapseReason = 'üí∞ Economy failed - poverty and famine devastated your lands';
            
            if (collapseReason) {
                gameState.gameOver = true;
                endGame(false, collapseReason);
                return;
            }

            const consequencesDiv = document.getElementById('consequences');
            let impactMessage = `‚ö° <strong>Decision Recorded:</strong><br>${choice.text}<br><br>`;
            
            Object.entries(modifiedEffects).forEach(([stat, val]) => {
                const icon = { stability: '‚öñÔ∏è', innovation: '‚ö°', culture: 'üé≠', economy: 'üí∞' }[stat];
                impactMessage += `${icon} ${stat.charAt(0).toUpperCase() + stat.slice(1)}: ${val > 0 ? '+' : ''}${val}<br>`;
            });
            
            if (prestigeEarned > 0) {
                impactMessage += `<br>üíé <strong>+${prestigeEarned} Prestige earned!</strong>`;
            }
            
            if (decayMessages.length > 0) {
                impactMessage += '<br><br>‚ö†Ô∏è <strong>Stat Decay Effects:</strong><br>' + decayMessages.join('<br>');
            }
            
            if (momentumResult.message) {
                impactMessage += '<br><br>' + momentumResult.message;
            }

            if (gameState.turn >= gameState.maxTurns) {
                impactMessage += '<br><br>üéä <strong>SURVIVED!</strong> Calculating your civilization\'s future...';
            }
            
            consequencesDiv.innerHTML = impactMessage;
            consequencesDiv.style.display = 'block';

            updateHistoryTimeline();
            updateRivalsDisplay();
            
            if (gameState.turn < gameState.maxTurns) {
                // Check for diplomatic phase
                if (checkDiplomaticPhase()) {
                    setTimeout(() => {
                        showDiplomaticPhase();
                        // Don't auto-advance - wait for user action
                    }, 3000);
                } else {
                    setTimeout(() => displayEvent(), 4000);
                }
            } else {
                setTimeout(() => endGame(true), 3000);
            }
        }

        function updateHistoryTimeline() {
            const timeline = document.getElementById('historyTimeline');
            timeline.innerHTML = gameState.decisions.map((d, i) => {
                const effectsText = Object.entries(d.effects)
                    .map(([stat, val]) => `${stat.substring(0, 3)}: ${val > 0 ? '+' : ''}${val}`)
                    .join(', ');
                return `
                    <div class="timeline-event">
                        <strong>Turn ${d.turn}: ${d.era}</strong><br>
                        ${d.choice}<br>
                        <em style="font-size: 0.9em;">üìä ${effectsText}</em>
                    </div>
                `;
            }).reverse().join('');
        }

        function endGame(victory, collapseReason = null) {
            const eventTitle = document.getElementById('eventTitle');
            const eventDesc = document.getElementById('eventDescription');
            const choicesContainer = document.getElementById('choicesContainer');
            const consequences = document.getElementById('consequences');
            
            if (!victory) {
                eventTitle.textContent = 'üíÄ CIVILIZATION COLLAPSED';
                eventDesc.textContent = collapseReason || 'Your civilization crumbled under the weight of poor decisions.';
                consequences.innerHTML = '<strong>‚ò†Ô∏è GAME OVER</strong><br><br>One of your critical attributes reached zero. Balance is key to survival!';
                consequences.style.display = 'block';
                choicesContainer.innerHTML = '<button class="choice-btn" onclick="resetGame()">üîÑ Try Again</button>';
                return;
            }
            
            const { stability, innovation, culture, economy, prestige, momentum } = gameState;
            const total = stability + innovation + culture + economy;
            const dominant = Math.max(stability, innovation, culture, economy);
            const weakest = Math.min(stability, innovation, culture, economy);
            
            // Check if player is strongest
            const aliveRivals = gameState.rivals.filter(r => r.alive);
            const rivalScores = aliveRivals.map(r => r.stability + r.innovation + r.culture + r.economy);
            const isStrongest = rivalScores.length === 0 || rivalScores.every(score => total >= score);
            const ranking = [total, ...rivalScores].sort((a, b) => b - a).indexOf(total) + 1;
            const rankEmoji = ranking === 1 ? 'ü•á' : ranking === 2 ? 'ü•à' : 'ü•â';
            const rankText = isStrongest ? ' - SUPREME LEADER' : ` - Rank ${rankEmoji}`;
            
            let futureTitle = '';
            let futureDesc = '';
            let rating = '';
            
            // S++ TIER: Hidden legendary paths
            if (prestige >= 30 && total > 300 && weakest > 50) {
                futureTitle = 'üëë THE LEGENDARY ASCENDANCY';
                futureDesc = `Through unparalleled wisdom and strategic mastery, you've achieved what historians call "The Impossible Balance." With ${prestige}üíé prestige earned and all attributes flourishing, your civilization transcends mortal limitations. You've unlocked hidden victory path: LEGEND STATUS. Your name becomes synonymous with divine leadership. Monuments spanning continents celebrate your reign. Future civilizations worship you as a god-king. This is the pinnacle - the 0.1% outcome.`;
                rating = 'S++ TIER VICTORY (LEGENDARY)';
            } else if (gameState.difficulty === 'nightmare' && total > 280 && weakest > 40) {
                futureTitle = 'üî• THE IMPOSSIBLE TRIUMPH';
                futureDesc = `Starting with crippled stats (30 each) on NIGHTMARE difficulty, you defied all odds. Surviving was unlikely - thriving was impossible. Yet here you stand with ${total} total points and ${prestige}üíé prestige. Historians call this "The Miracle Chronicle." Your story will inspire leaders for generations. Hidden achievement unlocked: NIGHTMARE CONQUEROR.`;
                rating = 'S++ TIER VICTORY (NIGHTMARE MASTER)';
            } else if (momentum >= 15 && total > 290) {
                futureTitle = '‚ö° THE UNSTOPPABLE MOMENTUM';
                futureDesc = `You maintained ${momentum} momentum throughout the late game - a feat achieved by less than 1% of leaders. Every decision reinforced the last, creating an unstoppable cascade of prosperity. Your civilization doesn't just succeed; it accelerates toward a utopian future. Hidden achievement: MOMENTUM EMPEROR.`;
                rating = 'S++ TIER VICTORY (MOMENTUM MASTER)';
            }
            // S TIER: Perfect balance
            else if (Math.abs(stability - innovation) < 15 && Math.abs(culture - economy) < 15 && total > 250 && weakest > 45) {
                futureTitle = '‚≠ê THE PERFECT CIVILIZATION';
                futureDesc = `Through masterful leadership, you achieved perfect harmony. Stability (${stability}), Innovation (${innovation}), Culture (${culture}), and Economy (${economy}) all flourish in balance. Your civilization becomes a beacon of hope, achieving unprecedented prosperity with ${prestige}üíé prestige. Historians will study your reign for millennia as the pinnacle of human achievement.`;
                rating = 'S-TIER VICTORY (PERFECT BALANCE)';
            }
            // A TIER: Dominant specialization
            else if (innovation === dominant && innovation > 75) {
                futureTitle = 'üöÄ THE TECHNO-UTOPIA';
                futureDesc = `Your relentless pursuit of innovation (${innovation}) has launched humanity into a golden age of technology. Flying cities, AI governance, and space colonies define your civilization. You earned ${prestige}üíé prestige through bold scientific choices. However, ${stability < 40 ? 'social instability' : culture < 40 ? 'cultural erosion' : 'economic inequality'} remains a persistent challenge.`;
                rating = innovation > 85 ? 'A+ TIER VICTORY' : 'A-TIER VICTORY';
            } else if (culture === dominant && culture > 75) {
                futureTitle = 'üé≠ THE CULTURAL RENAISSANCE';
                futureDesc = `Your dedication to culture (${culture}) created an artistic paradise. Philosophy, art, and tradition flourish, and your civilization's wisdom spreads globally. With ${prestige}üíé prestige from cultural mastery, your soft power is unmatched. Yet ${innovation < 40 ? 'technological stagnation' : economy < 40 ? 'economic struggles' : 'external threats'} loom on the horizon.`;
                rating = culture > 85 ? 'A+ TIER VICTORY' : 'A-TIER VICTORY';
            } else if (economy === dominant && economy > 75) {
                futureTitle = 'üíé THE GOLDEN EMPIRE';
                futureDesc = `Your economic mastery (${economy}) built the wealthiest civilization in history. Trade networks span the globe, prosperity is abundant, and your treasury overflows. You've amassed ${prestige}üíé prestige through shrewd deals. But ${stability < 40 ? 'inequality breeds unrest' : culture < 40 ? 'materialism erodes meaning' : 'innovation lags behind'}.`;
                rating = economy > 85 ? 'A+ TIER VICTORY' : 'A-TIER VICTORY';
            } else if (stability === dominant && stability > 75) {
                futureTitle = 'üèõÔ∏è THE ETERNAL ORDER';
                futureDesc = `Your focus on stability (${stability}) created an enduring civilization of law, order, and peace. Institutions are unshakeable and your people live in security. ${prestige}üíé prestige reflects your authoritative leadership. However, ${innovation < 40 ? 'progress has stalled' : culture < 40 ? 'conformity stifles creativity' : 'economic dynamism suffers'}.`;
                rating = stability > 85 ? 'A+ TIER VICTORY' : 'A-TIER VICTORY';
            }
            // B TIER: Balanced competence
            else if (total > 200 && weakest > 35) {
                futureTitle = 'üåü THE STABLE CIVILIZATION';
                futureDesc = `Your balanced approach created a functional civilization. With moderate scores across all attributes (Total: ${total}/400) and ${prestige}üíé prestige earned, your people enjoy reasonable prosperity. All stats above 35 shows competent leadership. History will remember you as a capable leader who kept the ship afloat through turbulent times.`;
                rating = total > 240 ? 'B+ TIER VICTORY' : 'B-TIER VICTORY';
            }
            // C TIER: Barely survived
            else if (total < 200) {
                futureTitle = '‚ö†Ô∏è THE STRUGGLING STATE';
                futureDesc = `Your civilization survives, but barely. With only ${total} total points and ${prestige}üíé prestige, all attributes remain weak. Your people face daily hardships. While you avoided total collapse, mediocrity defines your legacy. Future generations will remember this era as a time of missed opportunities and close calls.`;
                rating = 'C-TIER VICTORY';
            }
            // Default
            else {
                futureTitle = 'üìä THE SURVIVOR';
                futureDesc = `You survived the 10-turn challenge with ${total} points and ${prestige}üíé prestige, but just barely. One or more stats fell dangerously low (weakest: ${weakest}). Your civilization limps into the future, scarred but standing. It's not pretty, but survival counts for something.`;
                rating = 'C+ TIER VICTORY';
            }
            
            eventTitle.textContent = `üéä ${futureTitle}${rankText}`;
            eventDesc.textContent = futureDesc + `\n\nYou ranked ${rankEmoji} among ${aliveRivals.length + 1} civilizations.`;
            
            let bonusAchievements = '';
            if (prestige >= 20) bonusAchievements += 'üèÜ HIGH PRESTIGE MASTER<br>';
            if (momentum >= 10) bonusAchievements += '‚ö° MOMENTUM KEEPER<br>';
            if (gameState.difficulty === 'nightmare') bonusAchievements += 'üíÄ NIGHTMARE SURVIVOR<br>';
            if (gameState.difficulty === 'hard') bonusAchievements += '‚öîÔ∏è HARD MODE VICTOR<br>';
            
            consequences.innerHTML = `<strong>üèÜ ${rating}</strong><br><br>Final Stats: ‚öñÔ∏è${stability} ‚ö°${innovation} üé≠${culture} üí∞${economy}<br>üíé Prestige: ${prestige} | üìà Momentum: ${momentum}<br>üìä Total Score: ${total}/400<br><br>${bonusAchievements}`;
            consequences.style.display = 'block';
            choicesContainer.innerHTML = `
                <button class="choice-btn" onclick="resetGame()">üîÑ Play Again</button>
                <button class="choice-btn" onclick="shareStory()">üì§ Share Result</button>
            `;
        }

        function shareStory() {
            const { stability, innovation, culture, economy } = gameState;
            const total = stability + innovation + culture + economy;
            const text = `üé≠ Chronicle Builder Results:\n\nSurvived ${gameState.turn} turns!\nFinal Stats:\n‚öñÔ∏è Stability: ${stability}\n‚ö° Innovation: ${innovation}\nüé≠ Culture: ${culture}\nüí∞ Economy: ${economy}\nüìä Total Score: ${total}/400\n\nDecisions:\n${gameState.decisions.map((d, i) => `${i+1}. ${d.era}: ${d.choice}`).join('\n')}`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Your chronicle has been copied to clipboard!');
            }).catch(() => {
                alert('‚ùå Failed to copy. Try again!');
            });
        }

        function resetGame() {
            const currentDifficulty = gameState.difficulty || 'normal';
            const startingStats = {
                'normal': 50,
                'hard': 40,
                'nightmare': 30
            };
            const startValue = startingStats[currentDifficulty];
            
            gameState = {
                turn: 0,
                maxTurns: 10,
                stability: startValue,
                innovation: startValue,
                culture: startValue,
                economy: startValue,
                prestige: 0,
                reputation: {},
                activeThreats: [],
                achievements: [],
                momentum: 0,
                eventMemory: [],
                technologies: [],
                leader: null,
                difficulty: currentDifficulty,
                decisions: [],
                currentEra: null,
                gameOver: false
            };
            
            document.getElementById('historyTimeline').innerHTML = '<div style="text-align: center; color: #999;">Your chronicle will unfold here...</div>';
            document.getElementById('consequences').style.display = 'none';
            updateStats();
            displayEvent();
        }
    </script>
</body>
</html>
